<!-- chat/templates/chat/room.html -->
{% load static %}
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Bootstrap Icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
    <!-- SimpleLightbox plugin CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/static/css/styles.css" rel="stylesheet"/>
</head>
<body id="page-top">
    <div class="container-fluid mx-0 px-0 fixed-top">
    <!-- Navigation-->
        <div class="top-index bg-light py-1">
            <div class="cookie-bar">
            </div>
            <div class="row justify-content-around align-items-center">
                <div class="row px-0 col-lg-5 align-items-center">
                    <img class="col-lg-2 h-100" src="{% static 'assets/img/logo/logo.jpg' %}">
                    <h3 class="text-dark px-0 my-0 col-lg-9" id="nav-title">
                        Master Contrats en droit</br>français et européen
                    </h3>
                </div>
                <div class="col-lg-3 text-end">
                    <a class="mx-2" target="_blanck" href="https://www.linkedin.com/in/master-2-contrats-en-droit-fran%C3%A7ais-et-europ%C3%A9en-66863a179/"><img src="{% static 'assets/img/logo/linkedin.png' %}" id="linkedin-link"/></a>
                    <a class="btn mx-2 py-1 px-2 bg-primary text-light" id="mail-link" href="mailto:M2ContratsPoitiers@gmail.com">
                        Nous contacter
                    </a>
                </div>
            </div>
        </div>
        <nav class="nav-bar row px-0 mx-0 justify-content-center" id="nav-bar">
            <div class="section-bar row justify-content-center">
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet text-center" href="/">Accueil</a>
                </div>
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet text-center" href="/presentation">Présentation</a>
                    <ul class="sous-menu px-1 text-center bg-light">
                        <a class="nav-link py-1 fs-6" href="/presentation#master" >La formation</a>
                        <a class="nav-link py-1 fs-6" href="/presentation#programme" >Le programme</a>
                        <a class="nav-link py-1 fs-6" href="/presentation#team">L'équipe pédagogique</a>
                        <a class="nav-link py-1 fs-6" href="/presentation#director-word">Le mot des directeurs</a>
                        <a class="nav-link py-1 fs-6" href="/presentation#geo">La localisation</a>
                    </ul>
                </div>
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet text-center" href="/after">Et après ?</a>
                </div>
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet text-center" href="/ourstudent">Nos diplômé(e)s</a>
                    <ul class="sous-menu px-1 text-center bg-light">
                        <a class="nav-link py-1 fs-6" href="ourstudent#2020">2020-2021</a>
                        <a class="nav-link py-1 fs-6" href="ourstudent#2019">2019-2020</a>
                    </ul>
                </div>
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet text-center" href="/association">L'association</a>
                    <ul class="sous-menu px-1 text-center bg-light">
                        {% if request.user.is_superuser %}
                        <a class="nav-link py-1 fs-6" href="manage">Gestion du site</a>
                        {% endif %}
                    </ul>
                </div>
                <div class="navitem col-lg-2 px-0" >
                    <a class="nav-link onglet last text-center" href="/myspace">Espace étudiant</a>
                    <ul class="sous-menu px-1 text-center bg-light">
                        {% if request.user.is_staff %}
                        <a class="nav-link py-1 fs-6" href="helpdashboard">Espace entraide</a>
                        {% endif %}
                        {% if user.is_authenticated %}
                        <a class="nav-link py-1 fs-6" href="/log_out">Se déconnecter</a>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
    </div> 
</body>
    <div class="row justify-content-center" id="chat-page">
        <div class="box-chat row justify-content-center">
            <h3 class="text-primary mb-0 mt-2 text-center" id="nav-title">Chat publique</h3>
            <div id="chat-log"></div><br>
            <input id="chat-message-input" class="{{request.user}}" type="text" size="100"><br>
            <input id="chat-message-submit" type="button" class='{{ request.user.id|json_script:"user_id" }}' value="Envoyer">
            {{ room_name|json_script:"room-name" }}
            <script>
                const roomName = JSON.parse(document.getElementById('room-name').textContent);

                const chatSocket = new WebSocket(
                    'ws://'
                    + window.location.host
                    + '/ws/chat/'
                    + roomName
                    + '/'
                );


                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    const chat_log = document.querySelector('#chat-log');
                    const boxMsg = document.createElement('div');
                    boxMsg.innerHTML = '<p class="my-0 py-1 toast-body text-start text-dark" name=\"' + data.author + '\">' + data.author + " : " + data.message + '</p>';
                    chat_log.appendChild(boxMsg);
                    chat_log.scrollTo(0, chat_log.scrollHeight);
                };

                chatSocket.onclose = function(e) {
                    /* console.error('Chat socket closed unexpectedly'); */
                };

                document.querySelector('#chat-message-input').focus();
                document.querySelector('#chat-message-input').onkeyup = function(e) {
                    if (e.keyCode === 13) {  // enter, return
                        document.querySelector('#chat-message-submit').click();
                    }
                };

                document.querySelector('#chat-message-submit').onclick = function(e) {
                    const messageInputDom = document.querySelector('#chat-message-input');
                    const author =  messageInputDom.className;
                    const message = messageInputDom.value;
                    chatSocket.send(JSON.stringify({
                        'message': message,
                        'author': author,
                    }));
                    messageInputDom.value = '';
                };
            </script>
        </div>
    </div>
    <footer class="bg-purple py-3">
        <div class="container px-4 px-lg-5"><div class="small text-center text-muted">Copyright &copy; 2021 - Company Name</div></div>
    </footer>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SimpleLightbox plugin JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.js"></script>
    <!-- Core theme JS-->
    <script src="/static/js/scripts.js"></script>
    <script src="/static/js/scripts_staff_box.js"></script>
    <script src="/static/js/scripts_student_dash.js"></script>   
    <script src="/static/js/scripts_staff_dash.js"></script>   
</body>

